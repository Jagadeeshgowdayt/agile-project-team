name: "ğŸ§ª Advanced Frontend Performance Check"

on:
  push:
    paths:
      - '**/*.html'
      - '**/*.js'
      - '**/*.css'
  workflow_dispatch:

jobs:
  performance-checks:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: âš™ï¸ JS Function Complexity Check
        run: |
          set +e
          echo "ğŸ” Analyzing JavaScript for nested loops and large functions..."
          find . -name '*.js' | while read FILE; do
            echo "ğŸ“„ Checking $FILE"
            NESTED=$(grep -Pzo 'for\s*î€.*?î€\s*{[^{}]*{[^{}]*}' "$FILE" | wc -l)
            BIGFUNCS=$(awk '/function /{c=0;next}/}/&&c>30{print FILENAME " has long function"}{c++}' "$FILE")
            echo "ğŸ§  Nested loops: $NESTED"
            [ "$NESTED" -gt 0 ] && echo "âš ï¸ Potential O(nÂ²) behavior in $FILE"
            echo "$BIGFUNCS"
          done

      - name: ğŸ§  JS Memory Usage Estimate (Node)
        run: |
          echo "ğŸ” Estimating JS memory usage with dummy Node logic..."
          node -e "
            const used = process.memoryUsage();
            console.log('ğŸ§  Memory Usage:', Math.round(used.heapUsed / 1024 / 1024), 'MB');
          "

      - name: ğŸ—ï¸ DOM Size Check (HTML Complexity)
        run: |
          set +e
          echo "ğŸ” Checking HTML for large number of DOM nodes..."
          COUNT=$(grep -o '<[a-zA-Z]' index.html | wc -l)
          echo "ğŸ§± DOM Nodes in index.html: $COUNT"
          [ "$COUNT" -gt 300 ] && echo "âš ï¸ DOM too large â€“ may impact performance"

      - name: ğŸ§¬ Long Functions Warning
        run: |
          set +e
          echo "ğŸ” Checking for long JS functions..."
          find . -name '*.js' | while read FILE; do
            awk '/function /{c=0;next}/}/&&c>25{print FILENAME " has long function"}{c++}' "$FILE"
          done

      - name: ğŸŒ€ Deep Nesting Structure Detection
        run: |
          set +e
          echo "ğŸ” Checking for deeply nested loops or if-blocks..."
          find . -name '*.js' | while read FILE; do
            DEPTH=$(grep -o '{' "$FILE" | wc -l)
            if [ "$DEPTH" -gt 50 ]; then
              echo "âš ï¸ Deep nesting in $FILE â€“ consider simplifying logic"
            fi
          done

      - name: âœ… Final Success Pass
        run: |
          echo "ğŸ‰ All heuristic complexity and memory tests done! Workflow passes âœ…"
          exit 0
